version: '3'

vars:
  DIST_DIR: '{{.ROOT_DIR}}/dist'
  INIT_FILE: '{{.ROOT_DIR}}/zakuro_cache/__init__.py'

tasks:
  stamp:
    desc: Stamp __build__ in __init__.py with the current build date
    internal: true
    cmds:
      - |
        if grep -q '^__build__' {{.INIT_FILE}}; then
          sed -i 's/^__build__ = .*/__build__ = "{{.BUILD_DATE}}"/' {{.INIT_FILE}}
        else
          sed -i '/__version__/a __build__ = "{{.BUILD_DATE}}"' {{.INIT_FILE}}
        fi
    vars:
      BUILD_DATE:
        sh: TZ=Asia/Tokyo date +%Y-%m-%dT%H:%M:%S%z


  wheel:
    desc: Build wheel distribution with uv
    preconditions:
      - sh: command -v uv
        msg: "uv is required but not installed. Install with: curl -LsSf https://astral.sh/uv/install.sh | sh"
      - sh: test -f pyproject.toml
        msg: "pyproject.toml not found. Run /pygrade to migrate your setup.py first."
    cmds:
      - task: stamp
      - mkdir -p {{.DIST_DIR}}/legacy
      - cmd: mv {{.DIST_DIR}}/*.whl {{.DIST_DIR}}/legacy/ 2>/dev/null || true
      - uv build --wheel --out-dir {{.DIST_DIR}}

  sdist:
    desc: Build source distribution with uv
    preconditions:
      - sh: command -v uv
        msg: "uv is required but not installed. Install with: curl -LsSf https://astral.sh/uv/install.sh | sh"
      - sh: test -f pyproject.toml
        msg: "pyproject.toml not found. Run /pygrade to migrate your setup.py first."
    cmds:
      - task: stamp
      - mkdir -p {{.DIST_DIR}}
      - uv build --sdist --out-dir {{.DIST_DIR}}

  all:
    desc: Build wheel and source distribution
    deps:
      - wheel
      - sdist

  clean:
    desc: Remove dist directory
    cmds:
      - rm -rf {{.DIST_DIR}}
